name: "Cache version"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:

#  build:
#    runs-on: ${{ matrix.os }}
#    strategy:
#      fail-fast: false
#      matrix:
#        os: [ubuntu-latest, windows-latest]
#        python-version: ["3.9", "3.10"]
#        pytorch-version: ["1.11.0", "1.12.0"]
#
#    steps:
#    - name: Checkout
#      uses: actions/checkout@v3
#
#    - name: Set up Python ${{ matrix.python-version }}
#      uses: actions/setup-python@v3
#      with:
#        python-version: ${{ matrix.python-version }}
#
#    - name: Get pip cache dir
#      id: pip-cache
#      run: |
#        echo "::set-output name=dir::$(pip cache dir)"
#    - name: Cache dependencies
#      uses: actions/cache@v3
#      with:
#        path: ${{ steps.pip-cache.outputs.dir }}
#        key: ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-${{ hashFiles('**/requirements.txt') }}
#        restore-keys: |
#          ${{ matrix.os }}-py${{ matrix.python-version }}-pt${{ matrix.pytorch-version }}-pip-
#    - name: Install dependencies
#      run: |
#        python -m pip install --upgrade pip
#        pip install torch==${{ matrix.pytorch-version }}
#        pip install -r requirements.txt
#    - name: Test with pytest
#      run: |
#        pip install pytest
#        pytest -v
    
        
  deploy:
#        needs: build
        name: Setup Gcloud Account
        runs-on: ubuntu-latest
        env:
          IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_APP_NAME }}
        
        steps:
        - name: Login
          uses: google-github-actions/setup-gcloud@v0
          with:
            project_id: ${{ secrets.GCP_PROJECT_ID }}
            service_account_email: ${{ secrets.GCP_EMAIL }}
            service_account_key: ${{ secrets.GCP_CREDENTIALS }}

        - name: Configure Docker
          run: gcloud auth configure-docker --quiet

        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Build Docker image
          run: docker build . -t $IMAGE_NAME

        - name: Push Docker image
          run: docker push $IMAGE_NAME

        - name: Deploy Docker image
          run: gcloud run deploy ${{ secrets.GCP_PROJECT_ID }} --image $IMAGE_NAME --region us-central1 --platform managed
          
          
          
    
